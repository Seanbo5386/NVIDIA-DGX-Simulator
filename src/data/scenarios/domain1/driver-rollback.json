{
  "id": "domain1-driver-rollback",
  "title": "GPU Driver Rollback Procedures",
  "domain": "domain1",
  "difficulty": "advanced",
  "description": "Learn how to safely rollback NVIDIA GPU drivers when a driver update causes issues. Understanding driver management is critical for maintaining system stability.",
  "learningObjectives": [
    "Identify driver-related issues",
    "Understand driver versioning",
    "Perform safe driver rollback",
    "Verify driver functionality after rollback",
    "Document driver change management"
  ],
  "faults": [],
  "initialClusterState": {},
  "steps": [
    {
      "id": "step1",
      "title": "Identify Driver Issues",
      "description": "Recognize symptoms that indicate a driver update has caused problems.",
      "objectives": [
        "Check current driver status",
        "Identify error messages",
        "Review system logs for issues"
      ],
      "expectedCommands": [
        "nvidia-smi",
        "dmesg | grep -i nvidia | tail -30",
        "cat /var/log/nvidia-installer.log | tail -50"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must check driver status",
          "expectedCommands": ["nvidia-smi", "dmesg | grep -i nvidia"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Common symptoms: nvidia-smi fails, GPU not visible",
        "Check for 'NVRM' errors in dmesg",
        "Module load failures indicate driver issues",
        "XID errors after driver update suggest incompatibility",
        "Check /var/log/nvidia-installer.log for installation errors"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "NVIDIA Driver Troubleshooting",
          "url": "https://docs.nvidia.com/datacenter/"
        }
      ]
    },
    {
      "id": "step2",
      "title": "Document Current Driver Version",
      "description": "Record the current problematic driver version before proceeding with rollback.",
      "objectives": [
        "Get current driver version",
        "Check installed packages",
        "Document CUDA compatibility"
      ],
      "expectedCommands": [
        "nvidia-smi --query-gpu=driver_version --format=csv",
        "cat /proc/driver/nvidia/version",
        "dpkg -l | grep nvidia-driver"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must document current driver",
          "expectedCommands": ["nvidia-smi", "cat /proc/driver/nvidia/version"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Record the exact driver version causing issues",
        "Note CUDA version for compatibility",
        "Document any specific error messages",
        "This helps NVIDIA support if needed",
        "Package names vary by installation method"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "Driver Version Management",
          "url": "https://docs.nvidia.com/datacenter/"
        }
      ]
    },
    {
      "id": "step3",
      "title": "Identify Available Driver Versions",
      "description": "Find available driver versions that can be used for rollback.",
      "objectives": [
        "List available driver packages",
        "Identify previous known-good version",
        "Check version compatibility"
      ],
      "expectedCommands": [
        "apt-cache madison nvidia-driver-535",
        "apt-cache policy nvidia-driver-535",
        "ls /var/cache/apt/archives/ | grep nvidia"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must identify available versions",
          "expectedCommands": ["apt-cache madison nvidia-driver", "apt-cache policy nvidia-driver"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Use 'apt-cache madison' to see all available versions",
        "Previous version may still be in apt cache",
        "NVIDIA maintains multiple driver branches (535.x, 545.x, etc.)",
        "Check DGX release notes for supported versions",
        "Production branch recommended for stability"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "NVIDIA Driver Versions",
          "url": "https://www.nvidia.com/drivers"
        }
      ]
    },
    {
      "id": "step4",
      "title": "Stop GPU Workloads",
      "description": "Ensure all GPU workloads are stopped before driver modification.",
      "objectives": [
        "Identify running GPU processes",
        "Safely stop workloads",
        "Verify GPUs are idle"
      ],
      "expectedCommands": [
        "nvidia-smi",
        "nvidia-smi --query-compute-apps=pid,name --format=csv",
        "fuser -v /dev/nvidia*"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must verify no GPU workloads",
          "expectedCommands": ["nvidia-smi", "fuser -v /dev/nvidia"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Check 'Processes' section in nvidia-smi",
        "All GPUs should show 'No running processes'",
        "Stop any containers using GPUs",
        "Stop DCGM and monitoring services",
        "Slurm jobs must be drained/completed"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "GPU Process Management",
          "url": "https://docs.nvidia.com/datacenter/"
        }
      ]
    },
    {
      "id": "step5",
      "title": "Understand Rollback Procedure",
      "description": "Learn the steps for safely rolling back the driver version.",
      "objectives": [
        "Understand uninstall process",
        "Know package dependencies",
        "Learn reinstall procedure"
      ],
      "expectedCommands": [
        "dpkg -l | grep nvidia",
        "apt-cache depends nvidia-driver-535"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must understand driver packages",
          "expectedCommands": ["dpkg -l | grep nvidia"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Driver packages have dependencies (nvidia-driver, nvidia-utils, etc.)",
        "CUDA toolkit may need reinstall after driver change",
        "Fabric Manager version must match driver",
        "Use apt purge for clean removal",
        "Reboot required after driver change"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "Driver Installation Guide",
          "url": "https://docs.nvidia.com/datacenter/"
        }
      ]
    },
    {
      "id": "step6",
      "title": "Verify Rollback Success",
      "description": "After rollback, verify the driver is functioning correctly.",
      "objectives": [
        "Confirm driver version",
        "Verify all GPUs visible",
        "Check for any errors"
      ],
      "expectedCommands": [
        "nvidia-smi",
        "nvidia-smi -q | head -30",
        "dmesg | grep -i nvidia | tail -20"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must verify rollback success",
          "expectedCommands": ["nvidia-smi", "dmesg | grep -i nvidia"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "nvidia-smi should show all 8 GPUs",
        "No XID errors in dmesg",
        "Driver version should match target",
        "Fabric Manager must be restarted",
        "Test basic GPU operations"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Driver Verification",
          "url": "https://docs.nvidia.com/datacenter/"
        }
      ]
    },
    {
      "id": "step7",
      "title": "Verify Dependent Services",
      "description": "Ensure all dependent services are working after driver rollback.",
      "objectives": [
        "Check Fabric Manager status",
        "Verify DCGM operation",
        "Test NVLink functionality"
      ],
      "expectedCommands": [
        "systemctl status nvidia-fabricmanager",
        "dcgmi discovery -l",
        "nvidia-smi nvlink --status"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must verify dependent services",
          "expectedCommands": ["systemctl status nvidia-fabricmanager", "dcgmi discovery -l", "nvidia-smi nvlink --status"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Fabric Manager requires matching driver version",
        "DCGM should show all GPUs healthy",
        "NVLink topology should be intact",
        "Restart services if needed",
        "Run basic validation tests"
      ],
      "estimatedDuration": 8,
      "documentationLinks": [
        {
          "title": "Service Dependencies",
          "url": "https://docs.nvidia.com/datacenter/"
        }
      ]
    },
    {
      "id": "step8",
      "title": "Document and Report",
      "description": "Document the rollback and report issues to appropriate channels.",
      "objectives": [
        "Document rollback procedure used",
        "Record issue details for NVIDIA",
        "Update change management records"
      ],
      "expectedCommands": [
        "nvidia-smi -q > gpu_status_after_rollback.txt",
        "nvidia-bug-report.sh"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must document rollback",
          "expectedCommands": ["nvidia-smi -q"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Save nvidia-bug-report.sh output for support",
        "Document issue symptoms and timeline",
        "Record which driver versions affected",
        "Update internal change management",
        "Consider notifying NVIDIA support"
      ],
      "estimatedDuration": 8,
      "documentationLinks": [
        {
          "title": "NVIDIA Support",
          "url": "https://enterprise-support.nvidia.com/"
        }
      ]
    }
  ],
  "successCriteria": [
    "Identified driver-related issues",
    "Documented current driver version",
    "Identified available versions for rollback",
    "Verified no running GPU workloads",
    "Understood rollback procedure",
    "Verified rollback success",
    "Confirmed dependent services working",
    "Documented rollback procedure"
  ],
  "estimatedTime": 50,
  "prerequisites": ["domain1-driver-install", "domain1-driver-troubleshoot"],
  "tags": ["driver", "rollback", "troubleshooting", "maintenance", "advanced"]
}
