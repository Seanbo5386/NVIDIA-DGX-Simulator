{
  "id": "domain1-firmware-update",
  "title": "GPU and NIC Firmware Update Procedure",
  "domain": "domain1",
  "difficulty": "intermediate",
  "description": "Learn the proper procedure for updating GPU and network adapter firmware. This includes pre-checks, update commands, and verification.",
  "learningObjectives": [
    "Check current firmware versions",
    "Understand update prerequisites",
    "Execute firmware update commands",
    "Verify successful update"
  ],
  "faults": [],
  "initialClusterState": {},
  "steps": [
    {
      "id": "step1",
      "title": "Check Current GPU Firmware",
      "description": "Before updating, document the current firmware versions. The VBIOS version is critical for GPU firmware updates.",
      "objectives": ["Record current GPU VBIOS version"],
      "expectedCommands": ["nvidia-smi -q", "nvidia-smi --query-gpu=vbios_version --format=csv"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Check GPU firmware",
          "expectedCommands": ["nvidia-smi"],
          "requireAllCommands": true
        }
      ],
      "hints": ["nvidia-smi -q shows VBIOS version in GPU details"],
      "enhancedHints": [
        {
          "id": "step1-hint1",
          "level": 1,
          "message": "The nvidia-smi command can show detailed GPU information",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step1-hint2",
          "level": 2,
          "message": "Try: nvidia-smi -q | grep -i vbios",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        }
      ],
      "estimatedDuration": 3,
      "documentationLinks": [
        { "title": "NVIDIA Driver Documentation", "url": "https://docs.nvidia.com/datacenter/tesla/index.html" }
      ]
    },
    {
      "id": "step2",
      "title": "Check NIC Firmware",
      "description": "Check Mellanox/NVIDIA NIC firmware versions using mlxfwmanager. This tool queries all Mellanox devices.",
      "objectives": ["Record current NIC firmware"],
      "expectedCommands": ["mlxfwmanager --query", "mst status"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Check NIC firmware",
          "expectedCommands": ["mlxfwmanager", "mst"],
          "requireAllCommands": false
        }
      ],
      "hints": ["mlxfwmanager --query shows firmware versions"],
      "enhancedHints": [
        {
          "id": "step2-hint1",
          "level": 1,
          "message": "Mellanox Software Tools (MST) must be started first",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step2-hint2",
          "level": 2,
          "message": "Try: mst start && mlxfwmanager --query",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        }
      ],
      "estimatedDuration": 3,
      "documentationLinks": [
        { "title": "Mellanox Firmware Tools", "url": "https://docs.nvidia.com/networking/display/MFTEn" }
      ]
    },
    {
      "id": "step3",
      "title": "Review Update Prerequisites",
      "description": "Before updating firmware:\n- Drain node from scheduler to prevent new jobs\n- Stop running workloads gracefully\n- Ensure BMC access is available for recovery\n- Have previous firmware image for rollback\n- Verify power stability",
      "objectives": ["Understand update safety requirements"],
      "expectedCommands": ["scontrol update node=dgx-00 state=drain reason=firmware"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Drain node before update",
          "expectedCommands": ["scontrol"],
          "requireAllCommands": true
        }
      ],
      "hints": ["Always drain the node before firmware updates"],
      "enhancedHints": [
        {
          "id": "step3-hint1",
          "level": 1,
          "message": "Use scontrol to change node state in Slurm",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step3-hint2",
          "level": 2,
          "message": "Syntax: scontrol update NodeName=<node> State=drain Reason=\"<reason>\"",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        },
        {
          "id": "step3-hint3",
          "level": 3,
          "message": "Try: scontrol update NodeName=dgx-00 State=drain Reason=\"firmware update\"",
          "trigger": { "type": "time-based", "timeSeconds": 90 }
        }
      ],
      "estimatedDuration": 3
    },
    {
      "id": "step4",
      "title": "Verify Post-Update",
      "description": "After firmware update and reboot, verify the new versions are active and system health is good.",
      "objectives": ["Confirm firmware update success"],
      "expectedCommands": ["nvidia-smi -q", "mlxfwmanager --query", "dcgmi diag -r 1"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Verify GPU health post-update",
          "expectedCommands": ["nvidia-smi", "dcgmi diag"],
          "requireAllCommands": false
        }
      ],
      "hints": ["Run diagnostics after firmware updates to ensure system stability"],
      "enhancedHints": [
        {
          "id": "step4-hint1",
          "level": 1,
          "message": "DCGM diagnostics can verify GPU health after changes",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step4-hint2",
          "level": 2,
          "message": "Level 1 diag is quick, Level 3 is comprehensive",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        }
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        { "title": "DCGM Diagnostics", "url": "https://docs.nvidia.com/datacenter/dcgm/latest/user-guide/dcgm-diagnostics.html" }
      ]
    },
    {
      "id": "step5",
      "title": "Return Node to Service",
      "description": "After verifying firmware update success, return the node to the Slurm scheduler.",
      "objectives": ["Resume normal operations"],
      "expectedCommands": ["scontrol update node=dgx-00 state=idle"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Return node to service",
          "expectedCommands": ["scontrol"],
          "requireAllCommands": true
        },
        {
          "type": "output-match",
          "description": "Verify node state changed",
          "outputPattern": "idle|ready|resume"
        }
      ],
      "hints": ["Set state back to idle when ready to accept jobs"],
      "estimatedDuration": 2
    }
  ],
  "successCriteria": [
    "Checked current firmware versions",
    "Understood update prerequisites",
    "Properly drained node",
    "Verified post-update health",
    "Returned node to service"
  ],
  "estimatedTime": 20,
  "prerequisites": [],
  "tags": ["firmware", "update", "maintenance", "mlxfwmanager", "vbios", "domain1"]
}
