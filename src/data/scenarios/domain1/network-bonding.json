{
  "id": "domain1-network-bonding",
  "title": "Network Bonding and InfiniBand Configuration",
  "domain": "domain1",
  "difficulty": "intermediate",
  "description": "Understand network bonding concepts for high availability and link aggregation. Learn to verify InfiniBand HCA configuration and network redundancy.",
  "learningObjectives": [
    "Understand bonding modes and their use cases",
    "Verify InfiniBand HCA status",
    "Check network interface bonding",
    "Troubleshoot link failures"
  ],
  "faults": [],
  "initialClusterState": {},
  "steps": [
    {
      "id": "step1",
      "title": "Check InfiniBand HCAs",
      "description": "InfiniBand Host Channel Adapters (HCAs) provide high-bandwidth, low-latency network connectivity. Verify HCA status and port states.",
      "objectives": ["Identify InfiniBand devices"],
      "expectedCommands": ["ibstat", "ibstatus", "ibv_devinfo"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Check IB HCA status",
          "expectedCommands": ["ibstat"],
          "requireAllCommands": true
        }
      ],
      "hints": ["ibstat shows HCA port status and link layer"],
      "enhancedHints": [
        {
          "id": "step1-hint1",
          "level": 1,
          "message": "ibstat is the primary command for IB HCA status",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step1-hint2",
          "level": 2,
          "message": "Look for State: Active and Physical state: LinkUp",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        }
      ],
      "estimatedDuration": 3,
      "documentationLinks": [
        { "title": "InfiniBand Documentation", "url": "https://docs.nvidia.com/networking/display/MLNXOFEDv531001/InfiniBand+Fabric+Utilities" }
      ]
    },
    {
      "id": "step2",
      "title": "View Network Bond Status",
      "description": "Network bonding combines multiple interfaces for redundancy or increased throughput. Common modes include:\n- mode 1 (active-backup): failover only\n- mode 4 (802.3ad/LACP): dynamic link aggregation\n- mode 6 (balance-alb): adaptive load balancing",
      "objectives": ["Check bonding configuration"],
      "expectedCommands": ["cat /proc/net/bonding/bond0", "ip link show"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "View bonding info",
          "expectedCommands": ["cat", "ip link"],
          "requireAllCommands": false
        }
      ],
      "hints": ["/proc/net/bonding/ contains bond status"],
      "enhancedHints": [
        {
          "id": "step2-hint1",
          "level": 1,
          "message": "Bond status is in /proc/net/bonding/<bond_name>",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step2-hint2",
          "level": 2,
          "message": "Try: cat /proc/net/bonding/bond0",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        }
      ],
      "estimatedDuration": 3
    },
    {
      "id": "step3",
      "title": "Check IB Subnet Manager",
      "description": "The Subnet Manager (SM) manages the InfiniBand fabric. At least one SM must be active. For high availability, multiple SMs run with one active and others in standby.",
      "objectives": ["Verify subnet manager status"],
      "expectedCommands": ["sminfo", "ibswitches", "iblinkinfo"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Check SM status",
          "expectedCommands": ["sminfo", "ibswitches", "iblinkinfo"],
          "requireAllCommands": false
        }
      ],
      "hints": ["sminfo shows active subnet manager"],
      "enhancedHints": [
        {
          "id": "step3-hint1",
          "level": 1,
          "message": "The SM assigns LIDs and manages routing",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step3-hint2",
          "level": 2,
          "message": "Try: sminfo to see the active SM location",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        }
      ],
      "estimatedDuration": 3,
      "documentationLinks": [
        { "title": "Subnet Manager Guide", "url": "https://docs.nvidia.com/networking/display/MLNXOFEDv531001/OpenSM" }
      ]
    },
    {
      "id": "step4",
      "title": "Verify IB Link Quality",
      "description": "Check for link errors and quality issues. High error counts can indicate cable problems, switch issues, or HCA failures.",
      "objectives": ["Identify link quality issues"],
      "expectedCommands": ["perfquery", "ibdiagnet"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Check link performance",
          "expectedCommands": ["perfquery", "ibdiagnet"],
          "requireAllCommands": false
        }
      ],
      "hints": ["perfquery shows port counters including errors"],
      "enhancedHints": [
        {
          "id": "step4-hint1",
          "level": 1,
          "message": "perfquery shows port performance counters",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step4-hint2",
          "level": 2,
          "message": "Try: perfquery -x to see extended counters",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        },
        {
          "id": "step4-hint3",
          "level": 3,
          "message": "Look for SymbolErrors, LinkDownedCounter, RcvErrors",
          "trigger": { "type": "time-based", "timeSeconds": 90 }
        }
      ],
      "estimatedDuration": 3
    },
    {
      "id": "step5",
      "title": "Test RDMA Connectivity",
      "description": "RDMA (Remote Direct Memory Access) allows direct memory access between nodes without CPU involvement. Test basic RDMA connectivity.",
      "objectives": ["Verify RDMA works"],
      "expectedCommands": ["ibping", "ib_write_bw"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Test RDMA",
          "expectedCommands": ["ibping", "ib_write_bw", "ib_read_bw"],
          "requireAllCommands": false
        }
      ],
      "hints": ["ibping tests basic IB connectivity"],
      "enhancedHints": [
        {
          "id": "step5-hint1",
          "level": 1,
          "message": "ibping is like ping but for InfiniBand",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step5-hint2",
          "level": 2,
          "message": "ib_write_bw and ib_read_bw measure RDMA bandwidth",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        }
      ],
      "estimatedDuration": 3
    }
  ],
  "successCriteria": [
    "Checked InfiniBand HCA status",
    "Understood network bonding modes",
    "Verified subnet manager status",
    "Checked link quality",
    "Tested RDMA connectivity"
  ],
  "estimatedTime": 20,
  "prerequisites": [],
  "tags": ["network", "bonding", "infiniband", "hca", "rdma", "subnet-manager", "domain1"]
}
