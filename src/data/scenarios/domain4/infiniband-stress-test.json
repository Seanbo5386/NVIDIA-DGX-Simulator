{
  "id": "domain4-ib-stress",
  "title": "InfiniBand Fabric Stress Testing",
  "domain": "domain4",
  "difficulty": "advanced",
  "description": "Learn how to perform comprehensive stress testing on InfiniBand fabric to validate stability and performance under sustained load. Stress testing reveals issues that may not appear during normal operation.",
  "learningObjectives": [
    "Design IB stress test plan",
    "Run sustained bandwidth tests",
    "Monitor for errors during stress",
    "Test failure recovery",
    "Document stress test results"
  ],
  "faults": [],
  "initialClusterState": {},
  "steps": [
    {
      "id": "step1",
      "title": "Pre-Stress Fabric Assessment",
      "description": "Assess fabric health before beginning stress testing.",
      "objectives": [
        "Check all port status",
        "Record baseline error counts",
        "Verify fabric connectivity"
      ],
      "expectedCommands": [
        "ibstat",
        "ibdiagnet",
        "ibporterrors"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must assess fabric before stress",
          "expectedCommands": ["ibstat", "ibdiagnet", "ibporterrors"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "All ports should be Active",
        "Record current error counters",
        "Run ibdiagnet for full assessment",
        "Fix any existing issues first",
        "Document baseline state"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "IB Diagnostics",
          "url": "https://docs.nvidia.com/networking/"
        }
      ]
    },
    {
      "id": "step2",
      "title": "Configure Stress Test Parameters",
      "description": "Set up parameters for sustained bandwidth stress testing.",
      "objectives": [
        "Determine test duration",
        "Select test patterns",
        "Configure monitoring"
      ],
      "expectedCommands": [
        "ibstat",
        "cat /etc/hosts | grep dgx"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must configure stress parameters",
          "expectedCommands": ["ibstat", "cat /etc/hosts"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Typical stress test: 4-24 hours",
        "Use multiple traffic patterns",
        "All-to-all, bisection, random",
        "Monitor temperatures throughout",
        "Set up error alerting"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "Stress Testing",
          "url": "https://docs.nvidia.com/networking/"
        }
      ]
    },
    {
      "id": "step3",
      "title": "Run Sustained Bandwidth Test",
      "description": "Execute sustained bandwidth stress test across the fabric.",
      "objectives": [
        "Launch bandwidth tests",
        "Sustain maximum throughput",
        "Monitor for degradation"
      ],
      "expectedCommands": [
        "ib_write_bw -d mlx5_0 -D 300 --report_gbits",
        "ib_send_bw -d mlx5_0 -D 300 --report_gbits"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must run sustained bandwidth test",
          "expectedCommands": ["ib_write_bw -d mlx5_0 -D", "ib_send_bw -d mlx5_0 -D"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "-D 300 for 5-minute duration",
        "Run between all node pairs",
        "Use scripts for parallel testing",
        "Expected: sustained line rate",
        "Watch for bandwidth drops"
      ],
      "estimatedDuration": 10,
      "documentationLinks": [
        {
          "title": "perftest",
          "url": "https://github.com/linux-rdma/perftest"
        }
      ]
    },
    {
      "id": "step4",
      "title": "Monitor Errors During Stress",
      "description": "Continuously monitor for errors during stress testing.",
      "objectives": [
        "Watch error counters",
        "Monitor port status",
        "Track performance metrics"
      ],
      "expectedCommands": [
        "watch -n 5 ibporterrors",
        "perfquery -x"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must monitor errors during stress",
          "expectedCommands": ["watch -n 5 ibporterrors", "perfquery -x"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Error counters should not increase",
        "Watch for symbol errors (cable issue)",
        "Link recovery events indicate instability",
        "Port state changes are failures",
        "Log all errors with timestamps"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Error Monitoring",
          "url": "https://docs.nvidia.com/networking/"
        }
      ]
    },
    {
      "id": "step5",
      "title": "Test All-to-All Traffic Pattern",
      "description": "Stress test with all nodes communicating simultaneously.",
      "objectives": [
        "Generate all-to-all traffic",
        "Measure bisection bandwidth",
        "Check for congestion"
      ],
      "expectedCommands": [
        "ibstat",
        "iblinkinfo | grep -i active"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must test all-to-all pattern",
          "expectedCommands": ["ibstat", "iblinkinfo"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "All-to-all stresses entire fabric",
        "Uses OSU micro-benchmarks",
        "mpirun osu_alltoall",
        "Reveals routing bottlenecks",
        "Expected: near line rate aggregate"
      ],
      "estimatedDuration": 10,
      "documentationLinks": [
        {
          "title": "OSU Benchmarks",
          "url": "https://mvapich.cse.ohio-state.edu/benchmarks/"
        }
      ]
    },
    {
      "id": "step6",
      "title": "Test with GPU Direct RDMA",
      "description": "Stress test including GPU-to-GPU RDMA traffic.",
      "objectives": [
        "Enable GPU Direct RDMA",
        "Run GPU-aware bandwidth test",
        "Monitor GPU and NIC"
      ],
      "expectedCommands": [
        "nvidia-smi topo -m",
        "ibstat"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must test with GPU Direct RDMA",
          "expectedCommands": ["nvidia-smi topo -m", "ibstat"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "ib_write_bw --use_cuda for GDR",
        "Tests GPU-NIC-fabric-NIC-GPU path",
        "Most realistic for AI workloads",
        "Monitor both GPU and NIC metrics",
        "Check for GPU memory errors"
      ],
      "estimatedDuration": 10,
      "documentationLinks": [
        {
          "title": "GPU Direct RDMA",
          "url": "https://docs.nvidia.com/cuda/gpudirect-rdma/"
        }
      ]
    },
    {
      "id": "step7",
      "title": "Post-Stress Assessment",
      "description": "Assess fabric health after stress testing.",
      "objectives": [
        "Check final error counts",
        "Compare to pre-stress baseline",
        "Verify all ports still active"
      ],
      "expectedCommands": [
        "ibstat",
        "ibdiagnet",
        "ibporterrors"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must assess fabric after stress",
          "expectedCommands": ["ibstat", "ibdiagnet", "ibporterrors"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Compare error counts to baseline",
        "Small increase may be normal",
        "Large increase indicates issues",
        "All ports should still be Active",
        "Run full ibdiagnet report"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Post-Test Assessment",
          "url": "https://docs.nvidia.com/networking/"
        }
      ]
    },
    {
      "id": "step8",
      "title": "Document Stress Test Results",
      "description": "Create comprehensive stress test report.",
      "objectives": [
        "Compile all measurements",
        "Document any issues found",
        "Provide recommendations"
      ],
      "expectedCommands": [
        "ibdiagnet > stress_test_report.txt",
        "ibporterrors >> stress_test_report.txt"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must document stress test results",
          "expectedCommands": ["ibdiagnet >", "ibporterrors >>"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Include test duration and conditions",
        "Document all error counts",
        "List any ports requiring attention",
        "Provide pass/fail assessment",
        "Include recommendations"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Documentation",
          "url": "https://docs.nvidia.com/networking/"
        }
      ]
    }
  ],
  "successCriteria": [
    "Assessed fabric before stress",
    "Configured stress test parameters",
    "Ran sustained bandwidth tests",
    "Monitored errors during stress",
    "Tested all-to-all traffic",
    "Tested with GPU Direct RDMA",
    "Assessed fabric after stress",
    "Documented stress test results"
  ],
  "estimatedTime": 63,
  "prerequisites": ["domain4-cluster-health"],
  "tags": ["infiniband", "stress-test", "fabric", "validation", "advanced"]
}
