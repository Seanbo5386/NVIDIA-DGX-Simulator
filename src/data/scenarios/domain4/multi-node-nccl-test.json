{
  "id": "domain4-multinode-nccl",
  "title": "Multi-Node NCCL Bandwidth Test",
  "domain": "domain4",
  "difficulty": "advanced",
  "description": "Run NCCL collective operations across multiple nodes to verify GPU-to-GPU communication over the network fabric. This is critical for distributed training workloads.",
  "learningObjectives": [
    "Understand NCCL test parameters",
    "Run all_reduce across nodes",
    "Interpret bandwidth results",
    "Identify performance issues"
  ],
  "faults": [],
  "initialClusterState": {},
  "steps": [
    {
      "id": "step1",
      "title": "Verify InfiniBand Connectivity",
      "description": "Before running NCCL tests, ensure the InfiniBand fabric is healthy. All HCA ports should be Active with LinkUp state.",
      "objectives": ["Confirm IB links are up"],
      "expectedCommands": ["ibstat", "ibswitches", "iblinkinfo"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Check IB status",
          "expectedCommands": ["ibstat"],
          "requireAllCommands": true
        }
      ],
      "hints": ["ibstat shows HCA status and link state"],
      "enhancedHints": [
        {
          "id": "step1-hint1",
          "level": 1,
          "message": "ibstat shows per-port status for each HCA",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step1-hint2",
          "level": 2,
          "message": "Look for: State: Active, Physical state: LinkUp",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        }
      ],
      "estimatedDuration": 3,
      "documentationLinks": [
        { "title": "InfiniBand Fabric Utilities", "url": "https://docs.nvidia.com/networking/display/MLNXOFEDv531001/InfiniBand+Fabric+Utilities" }
      ]
    },
    {
      "id": "step2",
      "title": "Check GPU and NIC Topology",
      "description": "Verify GPUs and NICs are on the same NUMA node for optimal performance. Misaligned topology causes performance degradation.",
      "objectives": ["Verify GPU-NIC affinity"],
      "expectedCommands": ["nvidia-smi topo -m", "nvidia-smi topo -mp"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Check topology",
          "expectedCommands": ["nvidia-smi topo"],
          "requireAllCommands": true
        }
      ],
      "hints": ["nvidia-smi topo -m shows GPU topology matrix"],
      "enhancedHints": [
        {
          "id": "step2-hint1",
          "level": 1,
          "message": "The topology matrix shows connections between GPUs and NICs",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step2-hint2",
          "level": 2,
          "message": "PIX = same PCIe complex, SYS = cross-socket (slower)",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        }
      ],
      "estimatedDuration": 3
    },
    {
      "id": "step3",
      "title": "Run NCCL All-Reduce Test",
      "description": "Execute the NCCL all_reduce benchmark to measure collective bandwidth across nodes. This is the most common collective operation in distributed training.",
      "objectives": ["Run NCCL bandwidth test"],
      "expectedCommands": ["nccl-test", "all_reduce_perf"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Run NCCL test",
          "expectedCommands": ["nccl-test", "all_reduce"],
          "requireAllCommands": false
        }
      ],
      "hints": ["nccl-test runs the official NCCL tests"],
      "enhancedHints": [
        {
          "id": "step3-hint1",
          "level": 1,
          "message": "NCCL tests measure collective operation bandwidth",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step3-hint2",
          "level": 2,
          "message": "Try: nccl-test -t all_reduce -g 8 -b 1G -e 8G",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        },
        {
          "id": "step3-hint3",
          "level": 3,
          "message": "Parameters: -t (test type), -g (GPUs), -b (begin size), -e (end size)",
          "trigger": { "type": "time-based", "timeSeconds": 90 }
        }
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        { "title": "NCCL Tests", "url": "https://github.com/NVIDIA/nccl-tests" }
      ]
    },
    {
      "id": "step4",
      "title": "Interpret Results",
      "description": "Analyze the bandwidth numbers. Expected baselines for DGX systems:\n- Intra-node NVLink: ~600 GB/s aggregate\n- Inter-node IB HDR (8x): ~200 GB/s aggregate\n- Inter-node IB NDR (8x): ~400 GB/s aggregate\n\nDegraded performance indicates fabric or configuration issues.",
      "objectives": ["Understand expected performance"],
      "expectedCommands": ["nccl-test"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Review test output",
          "expectedCommands": ["nccl-test"],
          "requireAllCommands": false
        }
      ],
      "hints": ["Look for 'Avg bus bandwidth' in output"],
      "enhancedHints": [
        {
          "id": "step4-hint1",
          "level": 1,
          "message": "Bus bandwidth = algorithm bandwidth * 2 (for all-reduce)",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step4-hint2",
          "level": 2,
          "message": "If bandwidth is low, check: NIC affinity, IB errors, NCCL_IB_DISABLE",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        }
      ],
      "estimatedDuration": 5
    },
    {
      "id": "step5",
      "title": "Check for Errors",
      "description": "Verify no NCCL errors occurred during the test. Check kernel messages and GPU health.",
      "objectives": ["Confirm test completed successfully"],
      "expectedCommands": ["dmesg", "dcgmi health -c"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Check for errors",
          "expectedCommands": ["dmesg", "dcgmi health"],
          "requireAllCommands": false
        }
      ],
      "hints": ["dmesg may show NCCL-related kernel messages"],
      "enhancedHints": [
        {
          "id": "step5-hint1",
          "level": 1,
          "message": "Look for NCCL errors, GPU errors, or IB errors in dmesg",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step5-hint2",
          "level": 2,
          "message": "Try: dmesg | grep -i 'nccl\\|nvidia\\|mlx'",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        }
      ],
      "estimatedDuration": 3
    },
    {
      "id": "step6",
      "title": "Run Additional Collectives",
      "description": "Test other collective operations: all_gather, reduce_scatter, broadcast. Different workloads use different collectives.",
      "objectives": ["Verify other collective operations"],
      "expectedCommands": ["nccl-test -t all_gather", "nccl-test -t reduce_scatter"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Run additional tests",
          "expectedCommands": ["nccl-test"],
          "requireAllCommands": true
        }
      ],
      "hints": ["Different collectives have different bandwidth characteristics"],
      "enhancedHints": [
        {
          "id": "step6-hint1",
          "level": 2,
          "message": "all_gather: each GPU gathers data from all others\nreduce_scatter: reduce then scatter result",
          "trigger": { "type": "time-based", "timeSeconds": 45 }
        }
      ],
      "estimatedDuration": 5
    }
  ],
  "successCriteria": [
    "Verified IB connectivity",
    "Checked GPU-NIC topology",
    "Successfully ran NCCL all-reduce",
    "Understood performance baselines",
    "Confirmed no errors",
    "Tested multiple collective operations"
  ],
  "estimatedTime": 25,
  "prerequisites": ["domain4-nccl-test"],
  "tags": ["nccl", "multi-node", "bandwidth", "all-reduce", "collective", "infiniband", "distributed", "domain4"]
}
