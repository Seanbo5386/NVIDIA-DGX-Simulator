{
  "id": "domain4-nccl-multinode",
  "title": "Multi-Node NCCL Optimization",
  "domain": "domain4",
  "difficulty": "advanced",
  "description": "Learn how to optimize NCCL performance for multi-node distributed training. Proper NCCL configuration is critical for scaling AI training across multiple DGX systems.",
  "learningObjectives": [
    "Configure multi-node NCCL networking",
    "Optimize InfiniBand settings",
    "Tune NCCL environment variables",
    "Run multi-node NCCL tests",
    "Debug multi-node communication issues"
  ],
  "faults": [],
  "initialClusterState": {},
  "steps": [
    {
      "id": "step1",
      "title": "Verify InfiniBand Connectivity",
      "description": "Ensure InfiniBand fabric is properly configured for multi-node communication.",
      "objectives": [
        "Check IB port status",
        "Verify fabric connectivity",
        "Test node-to-node bandwidth"
      ],
      "expectedCommands": [
        "ibstat",
        "ibhosts",
        "ib_write_bw -d mlx5_0"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must verify IB connectivity",
          "expectedCommands": ["ibstat", "ibhosts"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "All IB ports should be 'Active'",
        "ibhosts shows all nodes in fabric",
        "ib_write_bw tests RDMA bandwidth",
        "HDR: ~200 Gb/s, NDR: ~400 Gb/s",
        "Multiple HCAs for higher aggregate bandwidth"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "InfiniBand Diagnostics",
          "url": "https://docs.nvidia.com/networking/"
        }
      ]
    },
    {
      "id": "step2",
      "title": "Configure NCCL Network Settings",
      "description": "Set up NCCL environment variables for InfiniBand networking.",
      "objectives": [
        "Enable InfiniBand in NCCL",
        "Configure GPU Direct RDMA",
        "Set network interface"
      ],
      "expectedCommands": [
        "export NCCL_IB_DISABLE=0",
        "export NCCL_NET_GDR_LEVEL=5",
        "export NCCL_IB_HCA=mlx5",
        "env | grep NCCL"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must configure NCCL network",
          "expectedCommands": ["export NCCL_IB_DISABLE=0", "export NCCL_NET_GDR_LEVEL", "env | grep NCCL"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "NCCL_IB_DISABLE=0 enables InfiniBand",
        "NCCL_NET_GDR_LEVEL=5 for GPU Direct RDMA",
        "NCCL_IB_HCA=mlx5 selects HCA devices",
        "NCCL_SOCKET_IFNAME for TCP fallback",
        "GPU Direct RDMA bypasses CPU"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "NCCL Environment Variables",
          "url": "https://docs.nvidia.com/deeplearning/nccl/user-guide/docs/env.html"
        }
      ]
    },
    {
      "id": "step3",
      "title": "Set Up MPI Environment",
      "description": "Configure MPI for launching multi-node NCCL tests.",
      "objectives": [
        "Verify MPI installation",
        "Configure hostfile",
        "Test MPI communication"
      ],
      "expectedCommands": [
        "mpirun --version",
        "cat /etc/hosts | grep dgx",
        "mpirun -np 2 -H node1,node2 hostname"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must set up MPI",
          "expectedCommands": ["mpirun --version", "mpirun -np 2 -H"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "OpenMPI or HPC-X MPI recommended",
        "SSH keys for passwordless access",
        "hostfile lists nodes: node slots=8",
        "Test basic MPI before NCCL",
        "UCX transport for InfiniBand"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "MPI Configuration",
          "url": "https://www.open-mpi.org/doc/"
        }
      ]
    },
    {
      "id": "step4",
      "title": "Configure NCCL Debug Output",
      "description": "Enable NCCL debug logging to verify configuration.",
      "objectives": [
        "Enable debug logging",
        "Verify network detection",
        "Check topology recognition"
      ],
      "expectedCommands": [
        "export NCCL_DEBUG=INFO",
        "export NCCL_DEBUG_SUBSYS=INIT,NET",
        "env | grep NCCL_DEBUG"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must configure debug output",
          "expectedCommands": ["export NCCL_DEBUG=INFO", "env | grep NCCL_DEBUG"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "NCCL_DEBUG=INFO for initialization info",
        "NCCL_DEBUG_SUBSYS filters output",
        "Look for 'Using network IB' message",
        "Check detected GPUs and topology",
        "NCCL_DEBUG=TRACE for detailed logs"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "NCCL Debug",
          "url": "https://docs.nvidia.com/deeplearning/nccl/user-guide/docs/env.html"
        }
      ]
    },
    {
      "id": "step5",
      "title": "Run Multi-Node NCCL Tests",
      "description": "Execute NCCL all_reduce performance tests across nodes.",
      "objectives": [
        "Launch multi-node test",
        "Measure inter-node bandwidth",
        "Compare with expectations"
      ],
      "expectedCommands": [
        "mpirun -np 16 -npernode 8 --hostfile hosts ./all_reduce_perf -b 1M -e 1G -f 2 -g 1",
        "srun -N 2 --ntasks-per-node=8 ./all_reduce_perf -b 1M -e 1G -f 2 -g 1"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must run multi-node NCCL tests",
          "expectedCommands": ["mpirun -np 16 -npernode 8", "srun -N 2 --ntasks-per-node=8"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "-npernode 8 for 8 GPUs per node",
        "-g 1 for one GPU per process",
        "Expected: 100-200 GB/s algBW at 1GB",
        "Inter-node limited by network",
        "busBW shows actual fabric utilization"
      ],
      "estimatedDuration": 10,
      "documentationLinks": [
        {
          "title": "NCCL Tests",
          "url": "https://github.com/NVIDIA/nccl-tests"
        }
      ]
    },
    {
      "id": "step6",
      "title": "Optimize NCCL Algorithm",
      "description": "Tune NCCL algorithm selection for multi-node performance.",
      "objectives": [
        "Understand Ring vs Tree",
        "Configure algorithm preference",
        "Test different protocols"
      ],
      "expectedCommands": [
        "export NCCL_ALGO=Ring",
        "export NCCL_PROTO=Simple",
        "mpirun -np 16 -npernode 8 ./all_reduce_perf -b 1G -e 1G"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must optimize NCCL algorithm",
          "expectedCommands": ["export NCCL_ALGO", "export NCCL_PROTO"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "NCCL_ALGO: Ring, Tree, or CollNet",
        "Ring good for small messages",
        "Tree better for large messages",
        "NCCL_PROTO: LL, LL128, Simple",
        "Let NCCL auto-select by default"
      ],
      "estimatedDuration": 8,
      "documentationLinks": [
        {
          "title": "NCCL Algorithms",
          "url": "https://docs.nvidia.com/deeplearning/nccl/user-guide/docs/env.html"
        }
      ]
    },
    {
      "id": "step7",
      "title": "Configure Network Buffers",
      "description": "Tune network buffer sizes for optimal performance.",
      "objectives": [
        "Set buffer sizes",
        "Configure socket options",
        "Optimize for message sizes"
      ],
      "expectedCommands": [
        "export NCCL_BUFFSIZE=4194304",
        "export NCCL_SOCKET_NTHREADS=4",
        "export NCCL_NSOCKS_PERTHREAD=4"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must configure network buffers",
          "expectedCommands": ["export NCCL_BUFFSIZE", "export NCCL_SOCKET_NTHREADS"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "NCCL_BUFFSIZE for staging buffers",
        "Larger buffers for large messages",
        "NCCL_NTHREADS controls parallelism",
        "Too many threads can hurt latency",
        "Default values often optimal"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "NCCL Tuning",
          "url": "https://docs.nvidia.com/deeplearning/nccl/user-guide/docs/env.html"
        }
      ]
    },
    {
      "id": "step8",
      "title": "Troubleshoot Multi-Node Issues",
      "description": "Debug common multi-node NCCL problems.",
      "objectives": [
        "Identify network issues",
        "Debug connection failures",
        "Resolve performance problems"
      ],
      "expectedCommands": [
        "NCCL_DEBUG=TRACE mpirun -np 16 ./all_reduce_perf -b 1M -e 1M 2>&1 | grep -E 'NET|IB|Error'",
        "ibstat",
        "nvidia-smi topo -m"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must troubleshoot multi-node issues",
          "expectedCommands": ["NCCL_DEBUG=TRACE", "ibstat", "nvidia-smi topo -m"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "TRACE level shows detailed network ops",
        "Check for 'bootstrap' errors (MPI issue)",
        "Check for 'NET' errors (fabric issue)",
        "ibstat verifies port status",
        "GPU-NIC affinity affects performance"
      ],
      "estimatedDuration": 8,
      "documentationLinks": [
        {
          "title": "NCCL Troubleshooting",
          "url": "https://docs.nvidia.com/deeplearning/nccl/user-guide/docs/troubleshooting.html"
        }
      ]
    }
  ],
  "successCriteria": [
    "Verified InfiniBand connectivity",
    "Configured NCCL network settings",
    "Set up MPI environment",
    "Configured NCCL debug output",
    "Ran multi-node NCCL tests",
    "Optimized NCCL algorithm",
    "Configured network buffers",
    "Troubleshot multi-node issues"
  ],
  "estimatedTime": 57,
  "prerequisites": ["domain4-nccl-test"],
  "tags": ["nccl", "multi-node", "distributed", "infiniband", "optimization", "advanced"]
}
