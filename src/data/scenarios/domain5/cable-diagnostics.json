{
  "id": "domain5-cable-diagnostics",
  "title": "InfiniBand Cable Diagnostics",
  "domain": "domain5",
  "difficulty": "intermediate",
  "description": "Learn to diagnose InfiniBand cable issues. Cable problems are a common source of performance degradation and connectivity issues in HPC clusters. This scenario covers cable testing, error detection, and replacement procedures.",
  "learningObjectives": [
    "Test InfiniBand cable integrity",
    "Identify cable-related errors",
    "Check cable performance metrics",
    "Understand cable replacement procedures"
  ],
  "faults": [],
  "initialClusterState": {},
  "steps": [
    {
      "id": "step1",
      "title": "Check Link Status",
      "description": "Start by checking the link status of all InfiniBand ports. Active links with proper physical state indicate healthy cable connections.",
      "objectives": ["Verify link status"],
      "expectedCommands": ["ibstat", "ibstatus"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Check IB link status",
          "expectedCommands": ["ibstat"],
          "requireAllCommands": true
        }
      ],
      "hints": ["ibstat shows State (logical) and Physical state (physical)"],
      "enhancedHints": [
        {
          "id": "step1-hint1",
          "level": 1,
          "message": "Look for: State: Active, Physical state: LinkUp",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step1-hint2",
          "level": 2,
          "message": "Polling/Disabled state = cable or port issue",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        }
      ],
      "estimatedDuration": 3,
      "documentationLinks": [
        {
          "title": "InfiniBand Troubleshooting",
          "url": "https://docs.nvidia.com/networking/display/MLNXOFEDv531001/Troubleshooting"
        }
      ]
    },
    {
      "id": "step2",
      "title": "Check Link Speed and Width",
      "description": "Verify links are running at expected speed and width. Reduced speed or width indicates cable quality issues or connector problems.",
      "objectives": ["Verify link performance"],
      "expectedCommands": ["ibstat", "iblinkinfo"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Check link speed",
          "expectedCommands": ["ibstat", "iblinkinfo"],
          "requireAllCommands": false
        }
      ],
      "hints": ["HDR = 200Gb/s, NDR = 400Gb/s, width should be 4x"],
      "enhancedHints": [
        {
          "id": "step2-hint1",
          "level": 1,
          "message": "Expected: HDR 200Gb/s 4x or NDR 400Gb/s 4x",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step2-hint2",
          "level": 2,
          "message": "Lower speed (FDR, EDR) or width (1x, 2x) = cable issue",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        }
      ],
      "estimatedDuration": 3
    },
    {
      "id": "step3",
      "title": "Check Port Error Counters",
      "description": "Review port error counters for signs of cable problems. Symbol errors, link downed counters, and receive errors indicate cable issues.",
      "objectives": ["Identify cable-related errors"],
      "expectedCommands": ["perfquery -x", "perfquery"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Check error counters",
          "expectedCommands": ["perfquery"],
          "requireAllCommands": true
        }
      ],
      "hints": ["perfquery -x shows extended counters"],
      "enhancedHints": [
        {
          "id": "step3-hint1",
          "level": 1,
          "message": "Key counters: SymbolErrors, LinkDownedCounter, RcvErrors",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step3-hint2",
          "level": 2,
          "message": "Non-zero error counts suggest cable or connector issues",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        },
        {
          "id": "step3-hint3",
          "level": 3,
          "message": "Clear counters with: perfquery -R to see new errors",
          "trigger": { "type": "time-based", "timeSeconds": 90 }
        }
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "InfiniBand Counters",
          "url": "https://docs.nvidia.com/networking/display/MLNXOFEDv531001/InfiniBand+Fabric+Utilities"
        }
      ]
    },
    {
      "id": "step4",
      "title": "Run Cable Diagnostics",
      "description": "Use mlxcables or mlxlink to run cable diagnostics. These tools can identify specific cable faults and quality issues.",
      "objectives": ["Run cable test tools"],
      "expectedCommands": ["mlxlink -d", "mlxcables"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Run cable diagnostics",
          "expectedCommands": ["mlxlink", "mlxcables"],
          "requireAllCommands": false
        }
      ],
      "hints": ["mlxlink provides detailed link information"],
      "enhancedHints": [
        {
          "id": "step4-hint1",
          "level": 1,
          "message": "mlxlink shows transceiver info, link status, and diagnostics",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step4-hint2",
          "level": 2,
          "message": "Try: mlxlink -d /dev/mst/mt41692_pciconf0 --show_fec",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        }
      ],
      "estimatedDuration": 5
    },
    {
      "id": "step5",
      "title": "Check Eye Diagram and Signal Quality",
      "description": "For advanced diagnostics, check signal quality metrics. Poor eye opening indicates cable degradation or connector issues.",
      "objectives": ["Understand signal quality"],
      "expectedCommands": ["mlxlink -d", "mlxlink --show_eye"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Check signal quality",
          "expectedCommands": ["mlxlink"],
          "requireAllCommands": true
        }
      ],
      "hints": ["Eye diagram quality correlates with cable health"],
      "enhancedHints": [
        {
          "id": "step5-hint1",
          "level": 1,
          "message": "Eye opening should be wide for healthy cables",
          "trigger": { "type": "time-based", "timeSeconds": 30 }
        },
        {
          "id": "step5-hint2",
          "level": 2,
          "message": "Grade A/B = good, Grade C/D = marginal, Grade F = replace cable",
          "trigger": { "type": "time-based", "timeSeconds": 60 }
        }
      ],
      "estimatedDuration": 5
    },
    {
      "id": "step6",
      "title": "Document and Report",
      "description": "Document findings for cable replacement. Include port location, error counts, and diagnostic results for proper tracking.",
      "objectives": ["Create cable issue report"],
      "expectedCommands": ["iblinkinfo -l", "ibnetdiscover"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Document topology",
          "expectedCommands": ["iblinkinfo", "ibnetdiscover"],
          "requireAllCommands": false
        }
      ],
      "hints": ["iblinkinfo -l shows link speeds across fabric"],
      "enhancedHints": [
        {
          "id": "step6-hint1",
          "level": 2,
          "message": "Document: switch port, HCA port, cable serial, error counts",
          "trigger": { "type": "time-based", "timeSeconds": 45 }
        }
      ],
      "estimatedDuration": 4
    }
  ],
  "successCriteria": [
    "Verified link status",
    "Checked link speed and width",
    "Reviewed error counters",
    "Ran cable diagnostics",
    "Understood signal quality metrics",
    "Documented findings"
  ],
  "estimatedTime": 25,
  "prerequisites": [],
  "tags": [
    "cable",
    "infiniband",
    "diagnostics",
    "mlxlink",
    "troubleshooting",
    "physical",
    "domain5"
  ],
  "tier": 2,
  "commandFamilies": ["infiniband-tools", "diagnostics"],
  "explanationGateId": "gate-domain5-cable-diagnostics"
}
