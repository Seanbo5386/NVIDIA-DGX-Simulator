{
  "id": "domain5-container-gpu",
  "title": "Container GPU Visibility Debugging",
  "domain": "domain5",
  "difficulty": "intermediate",
  "description": "Learn how to troubleshoot GPU visibility issues in containers. When GPUs are not visible inside containers, workloads fail to utilize GPU acceleration.",
  "learningObjectives": [
    "Diagnose missing GPU visibility",
    "Check container runtime configuration",
    "Verify NVIDIA Container Toolkit",
    "Debug driver issues",
    "Fix common configuration problems"
  ],
  "faults": [
    {
      "type": "container_gpu_visibility",
      "symptom": "no_gpus_visible"
    }
  ],
  "initialClusterState": {},
  "steps": [
    {
      "id": "step1",
      "title": "Verify Host GPU Status",
      "description": "Confirm GPUs are visible and working on the host system.",
      "objectives": [
        "Check nvidia-smi on host",
        "Verify driver is loaded",
        "Confirm GPU count"
      ],
      "expectedCommands": [
        "nvidia-smi",
        "lsmod | grep nvidia",
        "cat /proc/driver/nvidia/version"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must verify host GPU status",
          "expectedCommands": ["nvidia-smi", "lsmod | grep nvidia"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "GPUs must work on host first",
        "nvidia-smi should show all GPUs",
        "Driver modules must be loaded",
        "Check for XID errors",
        "Container inherits from host"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "Driver Verification",
          "url": "https://docs.nvidia.com/datacenter/"
        }
      ]
    },
    {
      "id": "step2",
      "title": "Check NVIDIA Container Toolkit",
      "description": "Verify NVIDIA Container Toolkit is installed and configured.",
      "objectives": [
        "Check toolkit installation",
        "Verify runtime configuration",
        "Check CDI support"
      ],
      "expectedCommands": [
        "nvidia-ctk --version",
        "cat /etc/docker/daemon.json",
        "nvidia-ctk cdi list"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must check Container Toolkit",
          "expectedCommands": ["nvidia-ctk --version", "cat /etc/docker/daemon.json"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "nvidia-ctk is Container Toolkit CLI",
        "daemon.json needs nvidia runtime",
        "default-runtime can be nvidia",
        "CDI provides device injection",
        "Restart Docker after config changes"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "NVIDIA Container Toolkit",
          "url": "https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/"
        }
      ]
    },
    {
      "id": "step3",
      "title": "Verify Docker Runtime Configuration",
      "description": "Check Docker is configured to use NVIDIA runtime.",
      "objectives": [
        "Check available runtimes",
        "Verify nvidia runtime",
        "Test runtime selection"
      ],
      "expectedCommands": [
        "docker info | grep -i runtime",
        "docker run --rm --gpus all nvidia/cuda:12.0-base nvidia-smi",
        "docker run --rm --runtime=nvidia nvidia/cuda:12.0-base nvidia-smi"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must verify Docker runtime",
          "expectedCommands": ["docker info | grep -i runtime", "docker run --rm --gpus all"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "--gpus all should expose GPUs",
        "--runtime=nvidia alternative method",
        "nvidia runtime must be registered",
        "Check for error messages",
        "Test with simple CUDA image"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Docker GPU Support",
          "url": "https://docs.docker.com/config/containers/resource_constraints/"
        }
      ]
    },
    {
      "id": "step4",
      "title": "Debug Container Startup",
      "description": "Diagnose issues during container GPU initialization.",
      "objectives": [
        "Enable debug logging",
        "Check container logs",
        "Identify failure point"
      ],
      "expectedCommands": [
        "docker logs <container_id>",
        "NVIDIA_DEBUG=1 docker run --rm --gpus all nvidia/cuda:12.0-base nvidia-smi"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must debug container startup",
          "expectedCommands": ["docker logs"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "NVIDIA_DEBUG=1 for verbose output",
        "Look for 'libnvidia' errors",
        "Check for permission denied",
        "CUDA version mismatch causes issues",
        "Container image must have CUDA"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Container Debugging",
          "url": "https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/"
        }
      ]
    },
    {
      "id": "step5",
      "title": "Check Device Files",
      "description": "Verify GPU device files are accessible.",
      "objectives": [
        "Check /dev/nvidia* files",
        "Verify permissions",
        "Check device visibility"
      ],
      "expectedCommands": [
        "ls -la /dev/nvidia*",
        "stat /dev/nvidia0",
        "docker run --rm --gpus all nvidia/cuda:12.0-base ls -la /dev/nvidia*"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must check device files",
          "expectedCommands": ["ls -la /dev/nvidia*", "docker run --rm --gpus all"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "/dev/nvidia0-7 for 8 GPUs",
        "/dev/nvidiactl is required",
        "/dev/nvidia-uvm for CUDA",
        "Devices must be inside container",
        "Permissions affect access"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "Device Files",
          "url": "https://docs.nvidia.com/datacenter/"
        }
      ]
    },
    {
      "id": "step6",
      "title": "Check Environment Variables",
      "description": "Verify NVIDIA environment variables in container.",
      "objectives": [
        "Check NVIDIA_VISIBLE_DEVICES",
        "Verify CUDA variables",
        "Ensure correct environment"
      ],
      "expectedCommands": [
        "docker run --rm --gpus all nvidia/cuda:12.0-base env | grep -i nvidia",
        "docker run --rm -e NVIDIA_VISIBLE_DEVICES=all nvidia/cuda:12.0-base env | grep -i nvidia"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must check environment variables",
          "expectedCommands": ["docker run --rm --gpus all nvidia/cuda env | grep"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "NVIDIA_VISIBLE_DEVICES controls GPUs",
        "NVIDIA_DRIVER_CAPABILITIES sets features",
        "Can override with -e flag",
        "Empty value disables GPUs",
        "'all' exposes all GPUs"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "Environment Variables",
          "url": "https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/"
        }
      ]
    },
    {
      "id": "step7",
      "title": "Test Specific GPU Selection",
      "description": "Verify ability to select specific GPUs.",
      "objectives": [
        "Test single GPU selection",
        "Test multiple GPU selection",
        "Verify GPU mapping"
      ],
      "expectedCommands": [
        "docker run --rm --gpus '\"device=0\"' nvidia/cuda:12.0-base nvidia-smi",
        "docker run --rm --gpus '\"device=0,1\"' nvidia/cuda:12.0-base nvidia-smi -L"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must test GPU selection",
          "expectedCommands": ["docker run --rm --gpus '\"device=0\"'", "docker run --rm --gpus '\"device=0,1\"'"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "--gpus '\"device=0\"' for GPU 0",
        "Can use UUID instead of index",
        "MIG instances have separate UUIDs",
        "Inside container: GPU 0 maps to selected",
        "CUDA_VISIBLE_DEVICES also works"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "GPU Selection",
          "url": "https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/"
        }
      ]
    },
    {
      "id": "step8",
      "title": "Resolve Common Issues",
      "description": "Fix identified configuration problems.",
      "objectives": [
        "Apply fix for identified issue",
        "Verify GPU visibility restored",
        "Document resolution"
      ],
      "expectedCommands": [
        "systemctl restart docker",
        "nvidia-ctk runtime configure --runtime=docker",
        "docker run --rm --gpus all nvidia/cuda:12.0-base nvidia-smi"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must resolve common issues",
          "expectedCommands": ["systemctl restart docker", "docker run --rm --gpus all"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "nvidia-ctk can fix daemon.json",
        "Docker restart applies config",
        "Reinstall toolkit if corrupt",
        "Check driver compatibility",
        "Verify fix with test container"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Troubleshooting",
          "url": "https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/"
        }
      ]
    }
  ],
  "successCriteria": [
    "Verified host GPU status",
    "Checked NVIDIA Container Toolkit",
    "Verified Docker runtime configuration",
    "Debugged container startup",
    "Checked device files",
    "Checked environment variables",
    "Tested specific GPU selection",
    "Resolved common issues"
  ],
  "estimatedTime": 46,
  "prerequisites": ["domain3-container-runtime"],
  "tags": ["containers", "docker", "gpu-visibility", "troubleshooting", "intermediate"]
}
