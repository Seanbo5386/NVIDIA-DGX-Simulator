{
  "id": "domain5-driver-mismatch",
  "title": "Driver Version Mismatch Resolution",
  "domain": "domain5",
  "difficulty": "intermediate",
  "description": "Learn how to diagnose and resolve NVIDIA driver version mismatch issues that can cause GPU functionality problems and workload failures.",
  "learningObjectives": [
    "Detect driver mismatches",
    "Understand version requirements",
    "Resolve kernel module conflicts",
    "Update driver correctly",
    "Verify compatibility"
  ],
  "faults": [
    {
      "type": "driver_mismatch",
      "symptom": "nvidia-smi_failure"
    }
  ],
  "initialClusterState": {},
  "steps": [
    {
      "id": "step1",
      "title": "Detect Driver Issues",
      "description": "Identify symptoms of driver version mismatch.",
      "objectives": [
        "Check nvidia-smi status",
        "Look for error messages",
        "Identify failure mode"
      ],
      "expectedCommands": [
        "nvidia-smi",
        "dmesg | grep -i nvidia | tail -30",
        "cat /proc/driver/nvidia/version"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must detect driver issues",
          "expectedCommands": ["nvidia-smi", "dmesg | grep -i nvidia"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "nvidia-smi may fail or show errors",
        "'mismatch' in dmesg indicates version issue",
        "/proc/driver/nvidia/version shows kernel module",
        "NVRM errors suggest driver problems",
        "Check for 'incompatible' messages"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "Driver Troubleshooting",
          "url": "https://docs.nvidia.com/datacenter/"
        }
      ]
    },
    {
      "id": "step2",
      "title": "Check Loaded Modules",
      "description": "Examine loaded NVIDIA kernel modules.",
      "objectives": [
        "List NVIDIA modules",
        "Check module versions",
        "Identify module conflicts"
      ],
      "expectedCommands": [
        "lsmod | grep nvidia",
        "modinfo nvidia | head -20",
        "modinfo nvidia-drm"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must check loaded modules",
          "expectedCommands": ["lsmod | grep nvidia", "modinfo nvidia"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "nvidia, nvidia-modeset, nvidia-drm modules",
        "modinfo shows module version",
        "All modules should be same version",
        "Multiple versions = conflict",
        "Check for nvidia-uvm for CUDA"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "Kernel Modules",
          "url": "https://docs.nvidia.com/datacenter/"
        }
      ]
    },
    {
      "id": "step3",
      "title": "Compare Installed Versions",
      "description": "Compare user-space and kernel-space versions.",
      "objectives": [
        "Check installed packages",
        "Compare versions",
        "Identify mismatch source"
      ],
      "expectedCommands": [
        "dpkg -l | grep nvidia-driver",
        "cat /proc/driver/nvidia/version",
        "nvidia-smi --query-gpu=driver_version --format=csv"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must compare installed versions",
          "expectedCommands": [
            "dpkg -l | grep nvidia",
            "cat /proc/driver/nvidia/version"
          ],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Package version vs kernel module version",
        "User-space libs match driver package",
        "Kernel module loaded at boot",
        "May need reboot after install",
        "DKMS rebuilds modules for kernel"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "Driver Installation",
          "url": "https://docs.nvidia.com/datacenter/"
        }
      ]
    },
    {
      "id": "step4",
      "title": "Check for Multiple Drivers",
      "description": "Look for conflicting driver installations.",
      "objectives": [
        "Find all NVIDIA packages",
        "Check for repo conflicts",
        "Identify duplicate installations"
      ],
      "expectedCommands": [
        "dpkg -l | grep -i nvidia | grep -i driver",
        "apt list --installed | grep nvidia",
        "ls /usr/lib/x86_64-linux-gnu/libnvidia*"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must check for multiple drivers",
          "expectedCommands": [
            "dpkg -l | grep -i nvidia",
            "apt list --installed | grep nvidia"
          ],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Multiple driver packages = conflict",
        "cuda-drivers vs nvidia-driver",
        "Different repos may have different versions",
        "Runfile vs package manager conflict",
        "Remove old before installing new"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "Package Management",
          "url": "https://docs.nvidia.com/datacenter/"
        }
      ]
    },
    {
      "id": "step5",
      "title": "Remove Conflicting Drivers",
      "description": "Clean up conflicting driver installations.",
      "objectives": [
        "Unload NVIDIA modules",
        "Remove conflicting packages",
        "Clean up residual files"
      ],
      "expectedCommands": [
        "sudo rmmod nvidia_drm nvidia_modeset nvidia_uvm nvidia",
        "sudo apt remove --purge nvidia-*",
        "sudo apt autoremove"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must remove conflicting drivers",
          "expectedCommands": ["rmmod nvidia", "apt remove --purge nvidia"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Stop GPU processes first",
        "rmmod unloads kernel modules",
        "Order matters: drm, modeset, uvm, nvidia",
        "purge removes config files",
        "May need to blacklist nouveau"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Driver Removal",
          "url": "https://docs.nvidia.com/datacenter/"
        }
      ]
    },
    {
      "id": "step6",
      "title": "Install Correct Driver Version",
      "description": "Install the appropriate driver version.",
      "objectives": [
        "Determine required version",
        "Install driver",
        "Verify installation"
      ],
      "expectedCommands": [
        "ubuntu-drivers devices",
        "sudo apt install nvidia-driver-535",
        "dkms status"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must install correct driver",
          "expectedCommands": [
            "ubuntu-drivers devices",
            "apt install nvidia-driver"
          ],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Check DGX release notes for version",
        "ubuntu-drivers suggests versions",
        "DKMS builds kernel modules",
        "Match CUDA toolkit requirements",
        "Server drivers recommended for datacenter"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Driver Installation",
          "url": "https://docs.nvidia.com/datacenter/"
        }
      ]
    },
    {
      "id": "step7",
      "title": "Reboot and Verify",
      "description": "Reboot system and verify driver is working.",
      "objectives": [
        "Reboot system",
        "Verify driver loads",
        "Check GPU functionality"
      ],
      "expectedCommands": [
        "sudo reboot",
        "nvidia-smi",
        "cat /proc/driver/nvidia/version"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must verify after reboot",
          "expectedCommands": ["nvidia-smi", "cat /proc/driver/nvidia/version"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Reboot loads new kernel modules",
        "nvidia-smi should work",
        "All GPUs should be visible",
        "Check for XID errors",
        "Verify CUDA toolkit works"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "Verification",
          "url": "https://docs.nvidia.com/datacenter/"
        }
      ]
    },
    {
      "id": "step8",
      "title": "Test GPU Functionality",
      "description": "Verify complete GPU functionality after fix.",
      "objectives": [
        "Run diagnostic tests",
        "Test CUDA workload",
        "Verify services work"
      ],
      "expectedCommands": [
        "nvidia-smi",
        "nvidia-smi -q | head -50",
        "dcgmi discovery -l"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must test GPU functionality",
          "expectedCommands": [
            "nvidia-smi",
            "nvidia-smi -q",
            "dcgmi discovery -l"
          ],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "nvidia-smi -q for detailed check",
        "Run DCGM diagnostics",
        "Test CUDA sample (vectorAdd)",
        "Check Fabric Manager if applicable",
        "Verify container GPU access"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Functionality Testing",
          "url": "https://docs.nvidia.com/datacenter/"
        }
      ]
    }
  ],
  "successCriteria": [
    "Detected driver issues",
    "Checked loaded modules",
    "Compared installed versions",
    "Checked for multiple drivers",
    "Removed conflicting drivers",
    "Installed correct driver version",
    "Rebooted and verified",
    "Tested GPU functionality"
  ],
  "estimatedTime": 46,
  "prerequisites": ["domain1-driver-install"],
  "tags": [
    "driver",
    "mismatch",
    "troubleshooting",
    "installation",
    "intermediate"
  ],
  "tier": 2,
  "commandFamilies": ["gpu-monitoring", "diagnostics"],
  "explanationGateId": "gate-domain5-driver-mismatch"
}
