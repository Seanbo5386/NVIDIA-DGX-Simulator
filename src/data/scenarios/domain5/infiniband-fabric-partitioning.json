{
  "id": "domain5-ib-partitioning",
  "title": "InfiniBand Fabric Partitioning Issues",
  "domain": "domain5",
  "difficulty": "advanced",
  "description": "Learn how to diagnose and resolve InfiniBand fabric partitioning issues where nodes cannot communicate across the fabric. Fabric partitioning can severely impact multi-node workloads.",
  "learningObjectives": [
    "Detect fabric partitioning",
    "Diagnose connectivity issues",
    "Understand IB routing",
    "Resolve partition problems",
    "Verify fabric health"
  ],
  "faults": [
    {
      "type": "ib_partition",
      "affectedNodes": ["dgx-03", "dgx-04"],
      "symptom": "cannot_reach"
    }
  ],
  "initialClusterState": {},
  "steps": [
    {
      "id": "step1",
      "title": "Detect Connectivity Issues",
      "description": "Identify which nodes cannot communicate over InfiniBand.",
      "objectives": [
        "Check IB port status",
        "Test node connectivity",
        "Identify affected paths"
      ],
      "expectedCommands": ["ibstat", "ibhosts", "ibnodes"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must detect connectivity issues",
          "expectedCommands": ["ibstat", "ibhosts"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "All local ports should be Active",
        "ibhosts lists all nodes in fabric",
        "Missing nodes = partitioned",
        "Use ibping to test specific nodes",
        "Note which nodes can/cannot be reached"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "IB Diagnostics",
          "url": "https://docs.nvidia.com/networking/"
        }
      ]
    },
    {
      "id": "step2",
      "title": "Check Local Port Status",
      "description": "Verify local InfiniBand HCA ports are properly configured.",
      "objectives": [
        "Check port state",
        "Verify link speed",
        "Check for local errors"
      ],
      "expectedCommands": ["ibstat", "ibporterrors", "perfquery"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must check local port status",
          "expectedCommands": ["ibstat", "ibporterrors"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "State should be 'Active'",
        "Physical state should be 'LinkUp'",
        "Check for high error counts",
        "Verify expected link speed (HDR/NDR)",
        "Local issues can cause fabric problems"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "Port Status",
          "url": "https://docs.nvidia.com/networking/"
        }
      ]
    },
    {
      "id": "step3",
      "title": "Examine Fabric Topology",
      "description": "Check the fabric topology and switch connectivity.",
      "objectives": [
        "View fabric topology",
        "Identify switch paths",
        "Find disconnected segments"
      ],
      "expectedCommands": [
        "iblinkinfo",
        "ibswitches",
        "ibnetdiscover > topology.txt"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must examine fabric topology",
          "expectedCommands": ["iblinkinfo", "ibswitches"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "iblinkinfo shows link status",
        "Look for 'Down' or 'Init' links",
        "ibswitches lists all switches",
        "Partitioning = unreachable switches",
        "ibnetdiscover maps full topology"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Topology Discovery",
          "url": "https://docs.nvidia.com/networking/"
        }
      ]
    },
    {
      "id": "step4",
      "title": "Check Subnet Manager Status",
      "description": "Verify the Subnet Manager is running and healthy.",
      "objectives": [
        "Check SM status",
        "Verify SM is master",
        "Look for SM errors"
      ],
      "expectedCommands": ["sminfo", "smpquery -G nodeinfo -D 0", "ibdiagnet"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must check SM status",
          "expectedCommands": ["sminfo", "ibdiagnet"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "sminfo shows Subnet Manager",
        "One SM should be Master",
        "No SM = fabric won't route",
        "SM failure causes partitioning",
        "OpenSM is common SM implementation"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Subnet Manager",
          "url": "https://docs.nvidia.com/networking/"
        }
      ]
    },
    {
      "id": "step5",
      "title": "Test Point-to-Point Connectivity",
      "description": "Test specific paths to isolate the partition boundary.",
      "objectives": [
        "Test connectivity to each node",
        "Identify partition boundary",
        "Map affected routes"
      ],
      "expectedCommands": [
        "ibping -G <remote_guid>",
        "ibtracert <local_lid> <remote_lid>"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must test point-to-point connectivity",
          "expectedCommands": ["ibping -G", "ibtracert"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "ibping tests IB connectivity",
        "ibtracert shows routing path",
        "Find where path fails",
        "Failed hop = problem location",
        "Test from multiple nodes"
      ],
      "estimatedDuration": 8,
      "documentationLinks": [
        {
          "title": "IB Connectivity Tests",
          "url": "https://docs.nvidia.com/networking/"
        }
      ]
    },
    {
      "id": "step6",
      "title": "Check for Cable and Port Issues",
      "description": "Identify physical layer issues causing partitioning.",
      "objectives": [
        "Check cable status",
        "Look for port errors",
        "Identify failed links"
      ],
      "expectedCommands": [
        "ibcableerrors",
        "iblinkinfo | grep -v Active",
        "mlxlink -d /dev/mst/SW_MT* -m"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must check cable and port issues",
          "expectedCommands": ["ibcableerrors", "iblinkinfo | grep"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Cable failures cause partitioning",
        "Look for non-Active links",
        "High error counts = bad cable",
        "mlxlink shows detailed port info",
        "Failed switch port = partition"
      ],
      "estimatedDuration": 8,
      "documentationLinks": [
        {
          "title": "Cable Diagnostics",
          "url": "https://docs.nvidia.com/networking/"
        }
      ]
    },
    {
      "id": "step7",
      "title": "Resolve Partitioning Issue",
      "description": "Apply appropriate resolution based on root cause.",
      "objectives": [
        "Address identified cause",
        "Restart SM if needed",
        "Verify connectivity restored"
      ],
      "expectedCommands": ["systemctl restart opensmd", "ibhosts", "ibdiagnet"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must resolve partitioning",
          "expectedCommands": ["ibhosts", "ibdiagnet"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "SM restart can fix routing issues",
        "Cable reseat for physical issues",
        "Switch reset for switch problems",
        "Verify all nodes visible after fix",
        "ibdiagnet should show no errors"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "IB Recovery",
          "url": "https://docs.nvidia.com/networking/"
        }
      ]
    },
    {
      "id": "step8",
      "title": "Verify Full Fabric Health",
      "description": "Confirm fabric is fully healthy after resolution.",
      "objectives": [
        "Run full diagnostics",
        "Test all-to-all connectivity",
        "Document resolution"
      ],
      "expectedCommands": ["ibdiagnet", "ibhosts | wc -l", "perfquery -x"],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must verify full fabric health",
          "expectedCommands": ["ibdiagnet", "ibhosts | wc"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "ibdiagnet should pass all checks",
        "All nodes should be visible",
        "Test NCCL multi-node communication",
        "Document root cause and fix",
        "Monitor for recurrence"
      ],
      "estimatedDuration": 8,
      "documentationLinks": [
        {
          "title": "Fabric Verification",
          "url": "https://docs.nvidia.com/networking/"
        }
      ]
    }
  ],
  "successCriteria": [
    "Detected connectivity issues",
    "Checked local port status",
    "Examined fabric topology",
    "Checked Subnet Manager status",
    "Tested point-to-point connectivity",
    "Checked cable and port issues",
    "Resolved partitioning issue",
    "Verified full fabric health"
  ],
  "estimatedTime": 55,
  "prerequisites": ["domain4-cluster-health"],
  "tags": [
    "infiniband",
    "partitioning",
    "fabric",
    "troubleshooting",
    "advanced"
  ],
  "tier": 3,
  "commandFamilies": ["infiniband-tools", "diagnostics"],
  "explanationGateId": "gate-domain5-ib-partitioning",
  "toolHints": false
}
