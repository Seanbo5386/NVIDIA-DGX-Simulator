{
  "id": "domain5-pcie-diagnosis",
  "title": "PCIe Bandwidth Degradation Diagnosis",
  "domain": "domain5",
  "difficulty": "advanced",
  "description": "Learn how to diagnose PCIe bandwidth degradation issues that can impact GPU and network performance. PCIe issues often manifest as unexpected performance drops.",
  "learningObjectives": [
    "Detect PCIe link degradation",
    "Identify root causes",
    "Test PCIe bandwidth",
    "Resolve configuration issues",
    "Know hardware vs software causes"
  ],
  "faults": [
    {
      "type": "pcie_degradation",
      "gpuIndex": 5,
      "currentWidth": "x8",
      "expectedWidth": "x16"
    }
  ],
  "initialClusterState": {},
  "steps": [
    {
      "id": "step1",
      "title": "Check PCIe Link Status",
      "description": "Query PCIe link speed and width for all GPUs.",
      "objectives": [
        "Check link width",
        "Check link speed",
        "Identify degraded links"
      ],
      "expectedCommands": [
        "nvidia-smi --query-gpu=pcie.link.gen.current,pcie.link.width.current --format=csv",
        "nvidia-smi -q -d PCIE"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must check PCIe link status",
          "expectedCommands": ["nvidia-smi --query-gpu=pcie.link.gen", "nvidia-smi -q -d PCIE"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Expected: Gen4 x16 for A100/H100",
        "Width x8 instead of x16 = degraded",
        "Gen3 instead of Gen4 = degraded",
        "Compare all GPUs for consistency",
        "Check both current and max capabilities"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "PCIe Status",
          "url": "https://docs.nvidia.com/datacenter/"
        }
      ]
    },
    {
      "id": "step2",
      "title": "Query Detailed PCIe Information",
      "description": "Get detailed PCIe topology and configuration.",
      "objectives": [
        "View PCIe tree",
        "Check slot capabilities",
        "Identify device locations"
      ],
      "expectedCommands": [
        "lspci -tv",
        "lspci -vvv -s <gpu_bus_id> | grep -E 'LnkCap|LnkSta'",
        "lspci | grep -i nvidia"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must query PCIe information",
          "expectedCommands": ["lspci -tv", "lspci | grep -i nvidia"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "LnkCap shows capability (max)",
        "LnkSta shows current status",
        "Compare Cap vs Sta for degradation",
        "Check intermediate switches",
        "Bus ID format: 0000:xx:00.0"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "lspci",
          "url": "https://linux.die.net/man/8/lspci"
        }
      ]
    },
    {
      "id": "step3",
      "title": "Check for PCIe Errors",
      "description": "Look for PCIe errors in system logs.",
      "objectives": [
        "Check kernel messages",
        "Look for AER errors",
        "Identify error patterns"
      ],
      "expectedCommands": [
        "dmesg | grep -i pcie",
        "dmesg | grep -i aer",
        "journalctl -k | grep -i 'pcie\\|aer'"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must check PCIe errors",
          "expectedCommands": ["dmesg | grep -i pcie", "dmesg | grep -i aer"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "AER = Advanced Error Reporting",
        "Correctable errors may not impact perf",
        "Uncorrectable errors are serious",
        "Link retraining messages indicate issues",
        "Frequent errors = hardware problem"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "PCIe Errors",
          "url": "https://www.kernel.org/doc/Documentation/PCI/"
        }
      ]
    },
    {
      "id": "step4",
      "title": "Test PCIe Bandwidth",
      "description": "Measure actual PCIe bandwidth to confirm degradation.",
      "objectives": [
        "Run bandwidth test",
        "Compare to expected values",
        "Identify affected transfers"
      ],
      "expectedCommands": [
        "nvidia-smi -q -d PCIE",
        "nvidia-smi --query-gpu=pcie.link.gen.current,pcie.link.width.current --format=csv"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must test PCIe bandwidth",
          "expectedCommands": ["nvidia-smi -q -d PCIE"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Use CUDA bandwidthTest",
        "Gen4 x16: ~25 GB/s each direction",
        "Gen4 x8: ~12.5 GB/s (degraded)",
        "Test H2D and D2H separately",
        "Low bandwidth confirms issue"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Bandwidth Testing",
          "url": "https://docs.nvidia.com/cuda/"
        }
      ]
    },
    {
      "id": "step5",
      "title": "Check BIOS Settings",
      "description": "Verify BIOS PCIe configuration is correct.",
      "objectives": [
        "Check SBIOS PCIe settings",
        "Verify slot configuration",
        "Look for bifurcation"
      ],
      "expectedCommands": [
        "dmidecode -t slot",
        "cat /sys/bus/pci/devices/*/max_link_width"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must check BIOS settings",
          "expectedCommands": ["dmidecode -t slot"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "PCIe bifurcation can cause x8",
        "Check BIOS for x16/x8 settings",
        "GPU slots should be x16",
        "IOMMU settings can affect PCIe",
        "Above 4G Decoding should be enabled"
      ],
      "estimatedDuration": 5,
      "documentationLinks": [
        {
          "title": "BIOS Configuration",
          "url": "https://docs.nvidia.com/dgx/"
        }
      ]
    },
    {
      "id": "step6",
      "title": "Attempt Software Recovery",
      "description": "Try software-based methods to restore link.",
      "objectives": [
        "Trigger link retraining",
        "Reset PCIe device",
        "Check if link improves"
      ],
      "expectedCommands": [
        "setpci -s <bus_id> CAP_EXP+10.w=0020:0020",
        "nvidia-smi -q -d PCIE"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must attempt software recovery",
          "expectedCommands": ["setpci -s", "nvidia-smi -q -d PCIE"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Link retraining may restore speed",
        "GPU reset can trigger retrain",
        "If software fails, cold reboot",
        "Persistent = hardware issue",
        "Check after recovery attempt"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "PCIe Recovery",
          "url": "https://www.kernel.org/doc/Documentation/PCI/"
        }
      ]
    },
    {
      "id": "step7",
      "title": "Diagnose Hardware Causes",
      "description": "Investigate potential hardware causes for degradation.",
      "objectives": [
        "Check physical connections",
        "Consider thermal issues",
        "Evaluate slot health"
      ],
      "expectedCommands": [
        "ipmitool sensor list | grep -i temp",
        "nvidia-smi -q -d TEMPERATURE"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must diagnose hardware causes",
          "expectedCommands": ["ipmitool sensor list", "nvidia-smi -q -d TEMPERATURE"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Loose GPU = intermittent issues",
        "High temps can cause link issues",
        "Damaged slot pins cause degradation",
        "Power issues affect PCIe",
        "May need physical inspection"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Hardware Troubleshooting",
          "url": "https://docs.nvidia.com/dgx/"
        }
      ]
    },
    {
      "id": "step8",
      "title": "Document and Escalate",
      "description": "Document findings and escalate hardware issues.",
      "objectives": [
        "Generate diagnostic report",
        "Document degradation details",
        "Escalate if hardware issue"
      ],
      "expectedCommands": [
        "nvidia-bug-report.sh",
        "lspci -vvv > pcie_diagnosis.log",
        "nvidia-smi -q >> pcie_diagnosis.log"
      ],
      "validationRules": [
        {
          "type": "command-executed",
          "description": "Must document and escalate",
          "expectedCommands": ["nvidia-bug-report.sh", "lspci -vvv >"],
          "requireAllCommands": true
        }
      ],
      "hints": [
        "Include lspci verbose output",
        "Document error messages",
        "Note if issue persists after reboot",
        "PCIe slot issues need hardware service",
        "GPU reseat may help loose connections"
      ],
      "estimatedDuration": 7,
      "documentationLinks": [
        {
          "title": "Support Escalation",
          "url": "https://enterprise-support.nvidia.com/"
        }
      ]
    }
  ],
  "successCriteria": [
    "Checked PCIe link status",
    "Queried detailed PCIe information",
    "Checked for PCIe errors",
    "Tested PCIe bandwidth",
    "Checked BIOS settings",
    "Attempted software recovery",
    "Diagnosed hardware causes",
    "Documented and escalated"
  ],
  "estimatedTime": 50,
  "prerequisites": ["domain1-driver-install"],
  "tags": ["pcie", "bandwidth", "troubleshooting", "degradation", "advanced"]
}
